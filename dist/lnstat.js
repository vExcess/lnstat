var __awaiter=(this&&this.__awaiter)||function(b,d,c,e){function a(f){return f instanceof c?f:new c(function(g){g(f)})}return new (c||(c=Promise))(function(j,i){function f(k){try{g(e.next(k))}catch(l){i(l)}}function h(k){try{g(e["throw"](k))}catch(l){i(l)}}function g(k){k.done?j(k.value):a(k.value).then(f,h)}g((e=e.apply(b,d||[])).next())})};var __generator=(this&&this.__generator)||function(i,d){var j={label:0,sent:function(){if(k[0]&1){throw k[1]}return k[1]},trys:[],ops:[]},e,h,k,c;return c={next:b(0),"throw":b(1),"return":b(2)},typeof Symbol==="function"&&(c[Symbol.iterator]=function(){return this}),c;function b(f){return function(g){return a([f,g])}}function a(g){if(e){throw new TypeError("Generator is already executing.")}while(c&&(c=0,g[0]&&(j=0)),j){try{if(e=1,h&&(k=g[0]&2?h["return"]:g[0]?h["throw"]||((k=h["return"])&&k.call(h),0):h.next)&&!(k=k.call(h,g[1])).done){return k}if(h=0,k){g=[g[0]&2,k.value]}switch(g[0]){case 0:case 1:k=g;break;case 4:j.label++;return{value:g[1],done:false};case 5:j.label++;h=g[1];g=[0];continue;case 7:g=j.ops.pop();j.trys.pop();continue;default:if(!(k=j.trys,k=k.length>0&&k[k.length-1])&&(g[0]===6||g[0]===2)){j=0;continue}if(g[0]===3&&(!k||(g[1]>k[0]&&g[1]<k[3]))){j.label=g[1];break}if(g[0]===6&&j.label<k[1]){j.label=k[1];k=g;break}if(k&&j.label<k[2]){j.label=k[2];j.ops.push(g);break}if(k[2]){j.ops.pop()}j.trys.pop();continue}g=d.call(i,j)}catch(f){g=[6,f];h=0}finally{e=k=0}}if(g[0]&5){throw g[1]}return{value:g[0]?g[1]:void 0,done:true}}};var fs=require("fs");function isDir(a){return fs.lstatSync(a).isDirectory()}function getFileExt(c){var a=c.length-1;while(a>0){if(c.charAt(a)==="/"){return null}else{if(c.charAt(a)==="."){var b=c.slice(a+1);if(b==="cjs"||b==="mjs"){b="js"}return b}}a--}return null}var extNameMap={js:"JavaScript",html:"HTML",css:"CSS",json:"JSON",ts:"TypeScript",md:"Markdown",py:"Python",java:"Java",rs:"Rust",zig:"Zig",c:"C",cpp:"C++",cs:"C#",csx:"C# (csx)",txt:"Plain Text",csv:"CSV"};function getFileStats(b,a){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(c){return[2,new Promise(function(m){var d={lines:0,code:0,comments:0,blanks:0};var f=fs.createReadStream(b,{encoding:"utf8"});var n=true;var l=false;var h=false;var i=false;var g=false;var k="";var e=false;var j="";f.on("data",function(t){var v=0;var p=0;var q=0;if(n){if(t.length>1){v++}n=false}if(["zig","rs"].includes(a)){var w=t.split("\n");v=w.length;for(var r=0;r<w.length;r++){var s=w[r].trimStart();if(s.length===0){q++}else{if(s.startsWith("//")){p++}}}}else{if(["py"].includes(a)){var w=t.split("\n");v=w.length;for(var r=0;r<w.length;r++){var s=w[r].trimStart();if(s.length===0){q++}else{if(s.startsWith("#")){p++}}}}else{if(["html","xml","md"].includes(a)){t=j+t;var u=0;while(u<t.length-3){var o=t[u];if(o==="\n"){if(e){q++}else{if(h){p++}}v++;e=true}else{if(!" \t".includes(o)){e=false;if(!h&&t.slice(u).startsWith("<!--")){p++;h=true;u+=3}else{if(h&&t.slice(u).startsWith("-->")){h=false;u+=2}}}}u++}j=t.slice(t.length-3)}else{if(["js","ts","java","c","cpp","cs","csx","css"].includes(a)){t=j+t;var u=0;while(u<t.length-1){var o=t[u];if(o==="\n"){if(e){q++}else{if(h){p++}}l=false;v++;e=true}else{if(!" \t".includes(o)){e=false;if(!h&&!l){if((i||g)&&o==="\\"){u+=2;continue}if(!i&&!g&&o==="/"){if(t[u+1]==="/"&&a!=="css"){p++;l=true;u++}else{if(t[u+1]==="*"){p++;h=true;u++}}}else{if(o==='"'){if(i&&k==='"'){i=false}else{if(!i){i=true;k='"'}}}else{if(o==="'"){if(i&&k==="'"){i=false}else{if(!i){i=true;k="'"}}}else{if(o==="`"&&["js","ts"].includes(a)){if(g&&k==="`"){g=false}else{if(!g){g=true;k="`"}}}}}}}else{if(h&&o==="*"&&t[u+1]==="/"){h=false;u++}}}}u++}j=t[t.length-1]}else{var w=t.split("\n");v=w.length;for(var r=0;r<w.length;r++){var s=w[r].trimStart();if(s.length===0){q++}}}}}}d.lines+=v;d.comments+=p;d.blanks+=q;d.code+=v-p-q}).on("end",function(){m(d)})})]})})}function getDirStats(b,a){return __awaiter(this,arguments,void 0,function(o,d,y){var v,u,t,h,f,w,l,x,q,g,p,s,c,m,r,r,g,e,p,n,c;if(y===void 0){y=0}return __generator(this,function(i){switch(i.label){case 0:v={path:o,extsStats:new Map(),subDirs:[]};u=fs.readdirSync(o);t=0;i.label=1;case 1:if(!(t<u.length)){return[3,6]}if(y===0){if(t>0){process.stdout.write("\r\x1b[K")}h=Math.round(t/u.length*100);process.stdout.write("[".concat("#".repeat(h/2)).concat("-".repeat(50-h/2),"] ").concat(h,"% Complete"))}f=u[t];if(!(f.charAt(0)!=="."||d.includeDotfiles)){return[3,5]}w=void 0;if(o.endsWith("/")){w=o+f.replaceAll("\\","/")}else{w=o+"/"+f.replaceAll("\\","/")}if(!isDir(w)){return[3,3]}return[4,getDirStats(w,d,y+1)];case 2:l=i.sent();v.subDirs.push(l);x=Array.from(l.extsStats.entries());for(q=0;q<x.length;q++){g=x[q][0];p=x[q][1];s=v.extsStats.get(g);if(!s){s={files:0,lines:0,code:0,comments:0,blanks:0};v.extsStats.set(g,s)}for(c in p){s[c]+=p[c]}}return[3,5];case 3:m=false;for(r=0;r<d.excludeRegexes.length;r++){if(d.excludeRegexes[r].test(w)){m=true;break}}for(r=0;r<d.filterRegexes.length;r++){if(!d.filterRegexes[r].test(w)){m=true;break}}if(m){return[3,5]}g=getFileExt(w);e=extNameMap[g];if(!(g&&(e||d.includeUnsupported))){return[3,5]}p=v.extsStats.get(g);if(!p){p={files:0,lines:0,code:0,comments:0,blanks:0};v.extsStats.set(g,p)}p.files++;if(!e){return[3,5]}return[4,getFileStats(w,g)];case 4:n=i.sent();for(c in n){p[c]+=n[c]}i.label=5;case 5:t++;return[3,1];case 6:if(y===0){process.stdout.write("\r\x1b[K")}return[2,v]}})})}function tablizeDirStats(f,d,a){var h;var g=Array.from(f.extsStats.entries());var b=[0,0,0,0,0];for(var e=0;e<g.length;e++){var p=g[e][1];b[0]+=p.files;b[1]+=p.lines;b[2]+=p.code;b[3]+=p.comments;b[4]+=p.blanks}function l(s,i){return""+Math.round(s/i*100)+"%"}var r=[[f.path,""+b[0],""+b[1],[l(b[2],b[1]),""+b[2]],[l(b[3],b[1]),""+b[3]],[l(b[4],b[1]),""+b[4]]]];g.sort(function(s,i){return i[1].lines-s[1].lines});for(var e=0;e<g.length;e++){var n=g[e][0];var p=g[e][1];var c=n;var k=String.fromCharCode(e<g.length-1?9500:9492);var o=k+String.fromCharCode(9472)+" ";var q=(h=extNameMap[c])!==null&&h!==void 0?h:n;var j="".concat(o).concat(q);if(p.lines!==0){r.push([j,""+p.files,[l(p.lines,b[1]),""+p.lines],[l(p.code,p.lines),""+p.code],[l(p.comments,p.lines),""+p.comments],[l(p.blanks,p.lines),""+p.blanks]])}else{r.push([j,""+p.files,["",""],["",""],["",""],["",""]])}}if(d<a){var m=[r];f.subDirs.forEach(function(t){var s=tablizeDirStats(t,d+1,a);var i=s[0][0];i=i.replace(f.path,"");i=(i.startsWith("/")?"...":".../")+i;s[0][0]=i;m.push(s)});return m}else{return r}}function mkRow(b,d,f){var e="";for(var a=0;a<b.length;a++){var g=b[a];var c="";if(typeof g==="string"){if(f[a]){c=g.padStart(d[a]," ")}else{c=g.padEnd(d[a]," ")}}else{c=g[0].padEnd(d[a]-g[1].length," ")+g[1]}e+=" "+c+" "+String.fromCharCode(9130)}return e}function displayResults(m){var g=["Language","Files","Lines","Code","Comments","Blanks"];var l=[false,true,true,true,true,true];var a=g.map(function(i){return i.length});for(var e=0;e<m.length;e++){var h=m[e];for(var d=0;d<h.length;d++){var p=h[d];for(var b=0;b<p.length;b++){var o=p[b];if(typeof o==="string"){if(o.length>a[b]){a[b]=o.length}}else{if(o[1].length+6>a[b]){a[b]=o[1].length+6}}}}}a=a.map(function(j,i){return i>2?j+2:j});var n=mkRow(g,a,Array(6).fill(false));var f=String.fromCharCode(9473).repeat(n.length);var c=a.map(function(i){return String.fromCharCode(9472).repeat(i+2)}).join(String.fromCharCode(9524))+String.fromCharCode(9496);console.log(f);console.log(n);console.log(f);for(var e=0;e<m.length;e++){var h=m[e];for(var d=0;d<h.length;d++){console.log(mkRow(h[d],a,l))}console.log(c)}}function showHelp(){var a=[["-iu, --include-unsupported","Include file count for unsupported file types"],["-id, --include-dotfiles","Include hidden directories"],["-e,  --exclude=<regex>","Skip paths matching given regex"],["-f,  --filter=<regex>","Skip paths not matching given regex"],["-h,  --help","Show this dialog"]].map(function(b){return"  "+b[0].padEnd(28," ")+b[1]}).join("\n");console.log(["usage: lnstat <path> [options]\n       lnstat [options] <path>","\noptions:\n"+a,'\nexamples:\n    lnstat ./node_modules -f=".*\\.ts"\n    lnstat --exclude=.*\\.css -ia ./\n    lnstat ../'].join("\n"))}function main(){return __awaiter(this,void 0,void 0,function(){var g,d,a,f,j,c,k,h,e,b;return __generator(this,function(i){switch(i.label){case 0:g=process.argv.slice(2);d=false;a=false;f=[];j=[];for(c=0;c<g.length;c++){k=g[c];if(k==="--include-unsupported"||k==="-iu"){d=true}else{if(k==="--include-dotfiles"||k==="-id"){a=true}else{if(k.startsWith("--exclude=")||k.startsWith("-e=")){f.push(new RegExp(k.slice(k.indexOf("=")+1)))}else{if(k.startsWith("--filter=")||k.startsWith("-f=")){j.push(new RegExp(k.slice(k.indexOf("=")+1)))}else{if(k==="--help"||k==="-h"||k==="-help"){showHelp();return[2]}}}}}}h=g.find(function(l){return l[0]!=="-"});if(!h){showHelp();return[2]}return[4,getDirStats(h.replaceAll("\\","/"),{includeUnsupported:d,includeDotfiles:a,excludeRegexes:f,filterRegexes:j})];case 1:e=i.sent();b=tablizeDirStats(e,0,1);displayResults(b);return[2]}})})}main();