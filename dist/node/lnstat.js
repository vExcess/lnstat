const fs=require("fs");function isDir(o){return fs.lstatSync(o).isDirectory()}function getFileExt(o){let l=o.length-1;for(;l>0;){if(o.charAt(l)==="/")return"";if(o.charAt(l)==="."){let h=o.slice(l+1);return(h==="cjs"||h==="mjs")&&(h="js"),h}l--}return""}const extNameMap={js:"JavaScript",html:"HTML",css:"CSS",json:"JSON",ts:"TypeScript",md:"Markdown",py:"Python",java:"Java",rs:"Rust",zig:"Zig",c:"C",cpp:"C++",cs:"C#",csx:"C# (csx)",txt:"Plain Text",csv:"CSV"};async function getFileStats(o,l){return new Promise(h=>{const i={lines:0,code:0,comments:0,blanks:0,avgLength:0,maxLength:0},n=fs.createReadStream(o,{encoding:"utf8"});let r=!0,u=!1,t=!1,e=!1,s=!1,c="",f=!1,d="";n.on("data",g=>{let p=0,x=0,b=0;r&&(g.length>1&&p++,r=!1);const S=g.split(`
`);for(let a=0;a<S.length;a++)S[a].length>i.maxLength&&(i.maxLength=S[a].length);if(["zig","rs"].includes(l)){p=S.length;for(let a=0;a<S.length;a++){const m=S[a].trimStart();m.length===0?b++:m.startsWith("//")&&x++}}else if(["py"].includes(l)){p=S.length;for(let a=0;a<S.length;a++){const m=S[a].trimStart();m.length===0?b++:m.startsWith("#")&&x++}}else if(["html","xml","md"].includes(l)){g=d+g;let a=0;for(;a<g.length-3;){const m=g[a];m===`
`?(f?b++:t&&x++,p++,f=!0):" 	".includes(m)||(f=!1,!t&&g.slice(a).startsWith("<!--")?(x++,t=!0,a+=3):t&&g.slice(a).startsWith("-->")&&(t=!1,a+=2)),a++}d=g.slice(g.length-3)}else if(["js","ts","java","c","cpp","cs","csx","css"].includes(l)){g=d+g;let a=0;for(;a<g.length-1;){const m=g[a];if(m===`
`)f?b++:t&&x++,u=!1,p++,f=!0;else if(!" 	".includes(m))if(f=!1,!t&&!u){if((e||s)&&m==="\\"){a+=2;continue}!e&&!s&&m==="/"?g[a+1]==="/"&&l!=="css"?(x++,u=!0,a++):g[a+1]==="*"&&(x++,t=!0,a++):m==='"'?e&&c==='"'?e=!1:e||(e=!0,c='"'):m==="'"?e&&c==="'"?e=!1:e||(e=!0,c="'"):m==="`"&&["js","ts"].includes(l)&&(s&&c==="`"?s=!1:s||(s=!0,c="`"))}else t&&m==="*"&&g[a+1]==="/"&&(t=!1,a++);a++}d=g[g.length-1]}else{p=S.length;for(let a=0;a<S.length;a++)S[a].trimStart().length===0&&b++}i.lines+=p,i.comments+=x,i.blanks+=b,i.code+=p-x-b,i.avgLength+=g.length}).on("end",()=>{i.lines>0&&(i.avgLength=(i.avgLength-i.lines)/i.lines),h(i)})})}async function getDirStats(o,l,h=0){const i={path:o,extsStats:new Map,subDirs:[]},n=fs.readdirSync(o);for(let r=0;r<n.length;r++){if(h===0){r>0&&process.stdout.write("\r\x1B[K");const t=Math.round(r/n.length*100);process.stdout.write(`[${"#".repeat(t/2)}${"-".repeat(50-t/2)}] ${t}% Complete`)}const u=n[r];if(u.charAt(0)!=="."||l.includeDotfiles){let t;if(o.endsWith("/")?t=o+u.replaceAll("\\","/"):t=o+"/"+u.replaceAll("\\","/"),isDir(t)){const e=await getDirStats(t,l,h+1);i.subDirs.push(e);const s=Array.from(e.extsStats.entries());for(let c=0;c<s.length;c++){const f=s[c][0],d=s[c][1];let g=i.extsStats.get(f);g||(g={files:0,lines:0,code:0,comments:0,blanks:0,avgLength:0,maxLength:0},i.extsStats.set(f,g));for(const p in d)g[p]+=d[p]}}else{let e=!1;for(let f=0;f<l.excludeRegexes.length;f++)if(l.excludeRegexes[f].test(t)){e=!0;break}for(let f=0;f<l.filterRegexes.length;f++)if(!l.filterRegexes[f].test(t)){e=!0;break}if(e)continue;const s=getFileExt(t),c=extNameMap[s];if(s.length!==0&&(c||l.includeUnsupported)){let f=i.extsStats.get(s);if(f||(f={files:0,lines:0,code:0,comments:0,blanks:0,avgLength:0,maxLength:0},i.extsStats.set(s,f)),f.files++,c){const d=await getFileStats(t,s);for(const g in d)f[g]+=d[g]}}}}}return h===0&&process.stdout.write("\r\x1B[K"),i}function tablizeDirStats(o,l,h){const i=Array.from(o.extsStats.entries()),n=[0,0,0,0,0,0,0];for(let t=0;t<i.length;t++){const e=i[t][1];n[0]+=e.files,n[1]+=e.lines,n[2]+=e.code,n[3]+=e.comments,n[4]+=e.blanks,n[5]+=e.avgLength,e.maxLength>n[6]&&(n[6]=e.maxLength)}n[5]=Math.round(n[5]/i.length);function r(t,e){return""+Math.round(t/e*100)+"%"}const u=[[o.path,""+n[0],""+n[1],[r(n[2],n[1]),""+n[2]],[r(n[3],n[1]),""+n[3]],[r(n[4],n[1]),""+n[4]],[""+n[5],""+n[6]]]];i.sort((t,e)=>e[1].lines-t[1].lines);for(let t=0;t<i.length;t++){const e=i[t][0],s=i[t][1],c=e,d=String.fromCharCode(t<i.length-1?9500:9492)+"\u2500 ",g=extNameMap[c]??e;s.lines!==0?u.push([d+g,""+s.files,[r(s.lines,n[1]),""+s.lines],[r(s.code,s.lines),""+s.code],[r(s.comments,s.lines),""+s.comments],[r(s.blanks,s.lines),""+s.blanks],[""+Math.round(s.avgLength),""+s.maxLength]]):u.push([d+g,""+s.files,["",""],["",""],["",""],["",""],["",""]])}if(l<h){const t=[u];return o.subDirs.forEach(e=>{const s=tablizeDirStats(e,l+1,h);let c=s[0][0];c=c.replace(o.path,""),c=(c.startsWith("/")?"...":".../")+c,s[0][0]=c,t.push(s)}),t}else return u}function mkRow(o,l,h){let i="";for(let n=0;n<o.length;n++){const r=o[n];let u="";typeof r=="string"?h[n]?u=r.padStart(l[n]," "):u=r.padEnd(l[n]," "):u=r[0].padEnd(l[n]-r[1].length," ")+r[1],i+=" "+u+" \u23AA"}return i}function displayResults(o){const l=["Language","Files","Lines","Code","Comments","Blanks","Avg/Max Len"],h=[!1,!0,!0,!0,!0,!0,!0];let i=l.map(t=>t.length);for(let t=0;t<o.length;t++){const e=o[t];for(let s=0;s<e.length;s++){const c=e[s];for(let f=0;f<c.length;f++){const d=c[f];typeof d=="string"?d.length>i[f]&&(i[f]=d.length):d[0].length+d[1].length+2>i[f]&&(i[f]=d[0].length+d[1].length+2)}}}const n=mkRow(l,i,Array(l.length).fill(!1)),r="\u2501".repeat(n.length),u=i.map(t=>"\u2500".repeat(t+2)).join("\u2534")+"\u2518";console.log(r),console.log(n),console.log(r);for(let t=0;t<o.length;t++){const e=o[t];for(let s=0;s<e.length;s++)console.log(mkRow(e[s],i,h));console.log(u)}}function showHelp(){const o=[["-iu, --include-unsupported","Include file count for unsupported file types"],["-id, --include-dotfiles","Include hidden directories"],["-e,  --exclude=<regex>","Skip paths matching given regex"],["-f,  --filter=<regex>","Skip paths not matching given regex"],["-h,  --help","Show this dialog"]].map(l=>"  "+l[0].padEnd(28," ")+l[1]).join(`
`);console.log([`usage: lnstat <path> [options]
       lnstat [options] <path>`,`
options:
`+o,`
examples:
    lnstat ./node_modules -f=".*\\.ts"
    lnstat --exclude=.*\\.css -ia ./
    lnstat index.js`].join(`
`))}async function main(){const o=process.argv.slice(2);let l=!1,h=!1,i=[],n=[];for(let t=0;t<o.length;t++){const e=o[t];if(e==="--include-unsupported"||e==="-iu")l=!0;else if(e==="--include-dotfiles"||e==="-id")h=!0;else if(e.startsWith("--exclude=")||e.startsWith("-e="))i.push(new RegExp(e.slice(e.indexOf("=")+1)));else if(e.startsWith("--filter=")||e.startsWith("-f="))n.push(new RegExp(e.slice(e.indexOf("=")+1)));else if(e==="--help"||e==="-h"||e==="-help"){showHelp();return}}let r=o.find(t=>t[0]!=="-");if(r)r=r.replaceAll("\\","/");else{showHelp();return}let u;if(isDir(r)){const t=await getDirStats(r,{includeUnsupported:l,includeDotfiles:h,excludeRegexes:i,filterRegexes:n});u=tablizeDirStats(t,0,1)}else{const t=getFileExt(r),e=await getFileStats(r,t),s={path:r,extsStats:new Map,subDirs:[]};s.extsStats.set(t,{files:1,lines:e.lines,code:e.code,comments:e.comments,blanks:e.blanks,avgLength:e.avgLength,maxLength:e.maxLength}),u=tablizeDirStats(s,0,1)}displayResults(u)}main();
